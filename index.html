<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ®ÙÙŠ Ù‡Ø¨Ù‘Ø© ğŸ­ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --neon-blue: #58a6ff; --bg-dark: #0d1117; --card-bg: #161b22; --accent: #3081ce; --red: #f85149; }
        body { background-color: var(--bg-dark); color: white; font-family: 'Tajawal', sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        .btn { background: var(--accent); border: none; color: white; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; }
        .screen { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
        .card { background: var(--card-bg); border: 2px solid var(--accent); border-radius: 20px; padding: 25px; width: 100%; max-width: 400px; text-align: center; }
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #30363d; background: #0d1117; color: white; margin-bottom: 12px; box-sizing: border-box; text-align: center; font-size: 14px; }
        #chat-container { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; background: #0d1117; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: #21262d; padding: 10px 15px; border-radius: 15px; max-width: 85%; align-self: flex-start; display: flex; align-items: flex-start; }
        .msg.me { align-self: flex-end; background: var(--accent); flex-direction: row-reverse; }
        .msg-avatar { width: 45px; height: 45px; border-radius: 12px; object-fit: cover; margin: 0 10px; border: 2px solid var(--neon-blue); }
        .msg-sender { font-size: 11px; color: var(--neon-blue); font-weight: 900; margin-bottom: 3px; }
        .msg.me .msg-sender { color: #fff; text-align: left; }
        .input-area { padding: 15px; background: #161b22; display: flex; gap: 10px; }
        #vote-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); display: flex; justify-content: center; align-items: center; z-index: 2000; padding: 20px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="setup-screen" class="screen">
        <div class="card">
            <h2 style="color: var(--neon-blue);">Ù…ØªØ®ÙÙŠ Ù‡Ø¨Ù‘Ø© ğŸ­</h2>
            <input type="number" id="roomNum" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©">
            <input type="text" id="realName" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ù…Ø®ÙÙŠ ğŸ”’)">
            <input type="text" id="fakeName" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©">
            <input type="text" id="userJob" placeholder="Ù…Ù‡Ù†ØªÙƒ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©">
            <input type="text" id="avatarStyle" placeholder="ÙƒÙŠÙ ØªØ¨ÙŠ Ø´ÙƒÙ„ÙƒØŸ (Ù…Ø«Ù„Ø§Ù‹: Ø±Ø§Ø¦Ø¯ ÙØ¶Ø§Ø¡ØŒ Ù‚Ø·Ø©)">
            <button class="btn" onclick="joinGame()">Ø¯Ø®ÙˆÙ„ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙØ§ØªØ§Ø± âœ¨</button>
        </div>
    </div>

    <div id="chat-screen" class="screen hidden" style="padding: 0;">
        <div id="chat-container">
            <div style="padding: 10px; background: #161b22; display: flex; justify-content: space-between; align-items: center;">
                <span id="room-tag" style="font-size: 12px; color: var(--red);"></span>
                <span id="player-tag" style="font-size: 12px;"></span>
                <button class="btn" style="width: auto; padding: 5px 10px; background: var(--red); font-size: 11px;" onclick="openVote()">Ø¥Ù‚ØµØ§Ø¡ ğŸš«</button>
            </div>
            <div id="messages"></div>
            <div class="input-area">
                <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." style="margin-bottom: 0;">
                <button class="btn" style="width: auto;" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <div id="vote-overlay" class="hidden">
        <div class="card" style="border-color: var(--red);">
            <h3 style="color: var(--red);">Ù…Ù† ØµØ§Ø­Ø¨ Ø§Ù„Ø´Ø®ØµÙŠØ©ØŸ ğŸ•µï¸â€â™‚ï¸</h3>
            <div id="players-to-vote" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; text-align: right;"></div>
            <input type="text" id="guessInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø®ÙˆÙŠÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ù†Ø§">
            <button class="btn" onclick="submitGuess()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙ‚Ø¹</button>
            <button class="btn" style="background:transparent; margin-top:5px;" onclick="closeVote()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBZfqpgix19pOGd_6xFMTV-p2YbrJmLwGo",
          authDomain: "mutakhafi-habba.firebaseapp.com",
          projectId: "mutakhafi-habba",
          storageBucket: "mutakhafi-habba.firebasestorage.app",
          messagingSenderId: "556976912934",
          appId: "1:556976912934:web:aa52c43ae4b0fd8f5344e7",
          databaseURL: "https://mutakhafi-habba-default-rtdb.europe-west1.firebasedatabase.app"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let myNick, myReal, myJob, myAvatar, myRoom;

        function joinGame() {
            myRoom = document.getElementById('roomNum').value;
            myReal = document.getElementById('realName').value;
            myNick = document.getElementById('fakeName').value;
            myJob = document.getElementById('userJob').value || "Ø¹Ø¶Ùˆ";
            const style = document.getElementById('avatarStyle').value || "cool";
            
            if(!myRoom || !myReal || !myNick) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©!");

            // ØªÙˆÙ„ÙŠØ¯ Ø£ÙØ§ØªØ§Ø± Ø°ÙƒÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØµÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            myAvatar = `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(style)}`;

            // Ø­ÙØ¸ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† Ø¨Ø§Ù„ØºØ±ÙØ© (Ù…Ø¹ Ø§Ø³Ù…Ù‡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ù„Ù…Ø®ÙÙŠ)
            const playerRef = db.ref(`rooms/${myRoom}/players/${myNick.replace(/[.#$[\]]/g, "")}`);
            playerRef.set({ fake: myNick, real: myReal, job: myJob, avatar: myAvatar });
            playerRef.onDisconnect().remove();

            document.getElementById('room-tag').innerText = `ØºØ±ÙØ©: ${myRoom}`;
            document.getElementById('player-tag').innerText = `${myNick} (${myJob})`;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');
            
            listenMessages();
        }

        function sendMsg() {
            const val = document.getElementById('msgInput').value;
            if(!val) return;
            db.ref(`rooms/${myRoom}/msgs`).push({ user: myNick, job: myJob, text: val, avatar: myAvatar });
            document.getElementById('msgInput').value = "";
        }

        function listenMessages() {
            db.ref(`rooms/${myRoom}/msgs`).limitToLast(20).on('child_added', snap => {
                const data = snap.val();
                const div = document.createElement('div');
                div.className = `msg ${data.user === myNick ? 'me' : ''}`;
                div.innerHTML = `<img src="${data.avatar}" class="msg-avatar">
                    <div class="msg-content"><div class="msg-sender">${data.user} [${data.job}]</div><div>${data.text}</div></div>`;
                document.getElementById('messages').appendChild(div);
                document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            });
        }

        function openVote() {
            const container = document.getElementById('players-to-vote');
            container.innerHTML = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†...";
            document.getElementById('vote-overlay').classList.remove('hidden');
            
            db.ref(`rooms/${myRoom}/players`).once('value', snap => {
                container.innerHTML = "";
                snap.forEach(child => {
                    if(child.val().fake !== myNick) {
                        const p = document.createElement('div');
                        p.style.padding = "5px";
                        p.innerHTML = `ğŸ‘¤ <b>${child.val().fake}</b> (${child.val().job})`;
                        container.appendChild(p);
                    }
                });
            });
        }

        function submitGuess() {
            const guess = document.getElementById('guessInput').value;
            if(!guess) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ!");
            db.ref(`rooms/${myRoom}/msgs`).push({ user: "ğŸ“¢ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù‚ØµØ§Ø¡", text: `ØªÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯: Ø£Ø­Ø¯Ù‡Ù… ÙŠØ¸Ù† Ø£Ù† Ø§Ù„Ù…ØªÙ†ÙƒØ± Ù‡Ùˆ [${guess}]!`, avatar: "https://api.dicebear.com/7.x/identicon/svg?seed=system" });
            document.getElementById('guessInput').value = "";
            closeVote();
        }

        function closeVote() { document.getElementById('vote-overlay').classList.add('hidden'); }
    </script>
</body>
</html>

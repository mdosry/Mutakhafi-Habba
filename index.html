<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ®ÙÙŠ Ù‡Ø¨Ù‘Ø© ğŸ­</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --neon: #00d2ff; --bg: #0a0c10; --red: #ff006e; --accent: #3a86ff; }
        body { background: var(--bg); color: white; font-family: 'Tajawal', sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        .btn { background: var(--accent); border: none; color: white; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-red { background: var(--red) !important; }
        .btn-green { background: #00c853 !important; }
        .screen { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .card { background: #1c1f26; border-radius: 20px; padding: 25px; width: 100%; max-width: 400px; text-align: center; border: 1px solid #333; }
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #0d1117; color: white; margin-bottom: 12px; text-align: center; }
        #chat-container { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; background: #0d1117; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: #21262d; padding: 10px; border-radius: 15px; max-width: 80%; align-self: flex-start; }
        .msg.me { align-self: flex-end; background: var(--accent); }
        .timer-bar { background: var(--red); height: 4px; width: 100%; transition: width 1s linear; }
        .top-bar { padding: 10px; background: #1c1f26; display: flex; justify-content: space-between; align-items: center; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="setup-screen" class="screen">
        <div class="card">
            <h2 style="color: var(--neon);">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ­</h2>
            <input type="number" id="roomNum" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©">
            <input type="text" id="fakeName" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">
            <input type="text" id="userJob" placeholder="Ù…Ù‡Ù…ØªÙƒ">
            <button class="btn" onclick="joinGame()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="chat-screen" class="screen hidden" style="padding: 0;">
        <div id="chat-container">
            <div id="timer-display" class="timer-bar"></div>
            <div class="top-bar">
                <button class="btn btn-red" style="width: auto; padding: 5px 10px;" onclick="location.reload()">Ø®Ø±ÙˆØ¬ ğŸšª</button>
                <button id="call-vote-btn" class="btn btn-green" style="width: auto; padding: 5px 10px;" onclick="requestVote()">ØªØµÙˆÙŠØª ğŸ“¢</button>
                <span id="time-text" style="color: var(--red); font-weight: bold;">05:00</span>
            </div>
            <div id="messages"></div>
            <div id="input-area" style="padding: 15px; background: #161b22; display: flex; gap: 10px;">
                <input type="text" id="msgInput" placeholder="ØªØ­Ø¯Ø«..." style="margin:0; flex:1;">
                <button class="btn" style="width: auto;" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <div id="overlay" class="hidden">
        <div class="card" id="overlay-content"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBZfqpgix19pOGd_6xFMTV-p2YbrJmLwGo",
            authDomain: "mutakhafi-habba.firebaseapp.com",
            projectId: "mutakhafi-habba",
            databaseURL: "https://mutakhafi-habba-default-rtdb.europe-west1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let myNick, myRoom, isObserver = false;

        function joinGame() {
            myRoom = document.getElementById('roomNum').value;
            myNick = document.getElementById('fakeName').value;
            const job = document.getElementById('userJob').value || "Ù…ÙˆØ§Ø·Ù†";
            if(!myRoom || !myNick) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");

            db.ref(`rooms/${myRoom}/players/${myNick}`).set({ job, status: 'playing' });
            db.ref(`rooms/${myRoom}/players/${myNick}`).onDisconnect().remove();

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');

            listenMessages();
            startGlobalTimer();
            listenPhase();
            listenStatus();
            listenVoteRequest();
        }

        function startGlobalTimer() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ù…Ù† Ù‚Ø¨Ù„ Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ Ù…ÙˆØ¬ÙˆØ¯
            setInterval(() => {
                db.ref(`rooms/${myRoom}/players`).limitToFirst(1).once('value', s => {
                    if(Object.keys(s.val()||{})[0] === myNick) {
                        db.ref(`rooms/${myRoom}/timer`).transaction(t => {
                            if (t === null) return 300;
                            return t > 0 ? t - 1 : 0;
                        });
                    }
                });
            }, 1000);

            // Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙˆÙ‚Øª Ù„Ù„ÙƒÙ„
            db.ref(`rooms/${myRoom}/timer`).on('value', snap => {
                let t = snap.val() !== null ? snap.val() : 300;
                const m = Math.floor(t/60), s = t%60;
                document.getElementById('time-text').innerText = `${m}:${s<10?'0':''}${s}`;
                document.getElementById('timer-display').style.width = (t/300*100) + "%";
                if(t <= 0) db.ref(`rooms/${myRoom}/phase`).set('voting');
            });
        }

        function requestVote() {
            if(isObserver) return;
            db.ref(`rooms/${myRoom}/voteRequest`).set({ requester: myNick });
            db.ref(`rooms/${myRoom}/requestAnswers/${myNick}`).set(true); // ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨ ÙŠÙˆØ§ÙÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        }

        function listenVoteRequest() {
            db.ref(`rooms/${myRoom}/voteRequest`).on('value', snap => {
                const data = snap.val();
                if(data && data.requester !== myNick) {
                    const content = document.getElementById('overlay-content');
                    content.innerHTML = `<h3>ğŸš¨ Ø·Ù„Ø¨ ØªØµÙˆÙŠØª!</h3><p><b>${data.requester}</b> ÙŠØ¨ÙŠ ÙŠØµÙˆØªØŒ ØªÙ…ØŸ</p>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-green" onclick="answerRequest(true)">ØªÙ… âœ…</button>
                            <button class="btn btn-red" onclick="answerRequest(false)">ÙŠØ¯Ø² âŒ</button>
                        </div>`;
                    document.getElementById('overlay').classList.remove('hidden');
                }
            });

            db.ref(`rooms/${myRoom}/requestAnswers`).on('value', snap => {
                const answers = snap.val() || {};
                const yesCount = Object.values(answers).filter(v => v === true).length;
                db.ref(`rooms/${myRoom}/players`).once('value', pSnap => {
                    const total = Object.keys(pSnap.val() || {}).length;
                    // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ø³Ø¨Ø©: Ø¥Ø°Ø§ ÙˆØ§ÙÙ‚ Ù†ØµÙ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø£Ùˆ Ø£ÙƒØ«Ø±
                    if(yesCount >= Math.ceil(total / 2) && total > 0) {
                        db.ref(`rooms/${myRoom}/phase`).set('voting');
                        db.ref(`rooms/${myRoom}/voteRequest`).remove();
                        db.ref(`rooms/${myRoom}/requestAnswers`).remove();
                    }
                });
            });
        }

        function answerRequest(ans) {
            db.ref(`rooms/${myRoom}/requestAnswers/${myNick}`).set(ans);
            document.getElementById('overlay-content').innerHTML = "<h3>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ù‚ÙŠØ©..</h3>";
        }

        function listenPhase() {
            db.ref(`rooms/${myRoom}/phase`).on('value', snap => {
                if(snap.val() === 'voting') showVoteScreen();
                else document.getElementById('overlay').classList.add('hidden');
            });
        }

        function showVoteScreen() {
            const content = document.getElementById('overlay-content');
            content.innerHTML = `<h3>Ø§Ù„ØªØµÙˆÙŠØª ğŸ—³ï¸</h3><div id="vote-list"></div>`;
            document.getElementById('overlay').classList.remove('hidden');
            db.ref(`rooms/${myRoom}/players`).once('value', snap => {
                snap.forEach(p => {
                    if(p.val().status === 'playing') {
                        const b = document.createElement('button');
                        b.className = "btn"; b.style.marginBottom = "5px";
                        b.innerText = `Ø·Ø±Ø¯ ${p.key}`;
                        b.onclick = () => {
                            db.ref(`rooms/${myRoom}/votes/${p.key}`).transaction(v => (v || 0) + 1);
                            content.innerHTML = "<h4>ØªÙ….. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h4>";
                            db.ref(`rooms/${myRoom}/players`).limitToFirst(1).once('v', s => {
                                if(Object.keys(s.val()||{})[0] === myNick) setTimeout(processVotes, 5000);
                            });
                        };
                        content.appendChild(b);
                    }
                });
            });
        }

        function processVotes() {
            db.ref(`rooms/${myRoom}/votes`).once('value', snap => {
                let max = 0, target = null;
                snap.forEach(v => { if(v.val() > max) { max = v.val(); target = v.key; } });
                if(target) db.ref(`rooms/${myRoom}/players/${target}/status`).set('observer');
                db.ref(`rooms/${myRoom}/votes`).remove();
                db.ref(`rooms/${myRoom}/timer`).set(300);
                db.ref(`rooms/${myRoom}/phase`).set('chat');
            });
        }

        function listenStatus() {
            db.ref(`rooms/${myRoom}/players/${myNick}/status`).on('value', snap => {
                if(snap.val() === 'observer') {
                    isObserver = true;
                    document.getElementById('input-area').innerHTML = "<p style='color:gray; width:100%; text-align:center;'>Ø£Ù†Øª Ù…Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¢Ù† ğŸ‘ï¸</p>";
                }
            });
        }

        function sendMsg() {
            if(isObserver) return;
            const val = document.getElementById('msgInput').value;
            if(!val) return;
            db.ref(`rooms/${myRoom}/msgs`).push({ user: myNick, text: val });
            document.getElementById('msgInput').value = "";
        }

        function listenMessages() {
            db.ref(`rooms/${myRoom}/msgs`).on('child_added', snap => {
                const data = snap.val();
                const div = document.createElement('div');
                div.className = `msg ${data.user === myNick ? 'me' : ''}`;
                div.innerHTML = `<small>${data.user}</small><br>${data.text}`;
                document.getElementById('messages').appendChild(div);
                document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            });
        }
    </script>
</body>
</html>

<script>
    // ... (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª firebaseConfig Ùˆ joinGame ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ...

    function listenPhase() {
        db.ref(`rooms/${myRoom}/phase`).on('value', snap => {
            const phase = snap.val();
            if(phase === 'voting') {
                isVotingNow = true;
                showVoteScreen();
            } else if(phase === 'chat') {
                isVotingNow = false;
                // Ø£Ù‡Ù… ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
                document.getElementById('overlay').classList.add('hidden');
                document.getElementById('overlay-content').innerHTML = ""; 
                db.ref(`rooms/${myRoom}/voteRequest`).remove();
                db.ref(`rooms/${myRoom}/requestAnswers`).remove();
            }
        });
    }

    function showVoteScreen() {
        const content = document.getElementById('overlay-content');
        content.innerHTML = `<h3>Ø§Ù„ØªØµÙˆÙŠØª Ù„Ù„Ø·Ø±Ø¯ ğŸ—³ï¸</h3><div id="vote-list"></div>`;
        document.getElementById('overlay').classList.remove('hidden');
        
        db.ref(`rooms/${myRoom}/players`).once('value', snap => {
            let hasTargets = false;
            snap.forEach(p => {
                if(p.val().status === 'playing' && p.key !== myNick) {
                    hasTargets = true;
                    const b = document.createElement('button');
                    b.className = "btn"; b.style.marginBottom = "8px";
                    b.innerText = `Ø·Ø±Ø¯ ${p.key}`; 
                    b.onclick = () => {
                        db.ref(`rooms/${myRoom}/votes/${p.key}`).transaction(v => (v || 0) + 1);
                        content.innerHTML = "<h4>ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙƒ! Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬.. ğŸ”’</h4>";
                        
                        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ Ù†Ø´Ø· ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ù…Ù‡Ù…Ø©
                        db.ref(`rooms/${myRoom}/players`).limitToFirst(5).once('value', s => {
                            const firstActive = Object.keys(s.val() || {}).find(k => s.val()[k].status === 'playing');
                            if(firstActive === myNick) {
                                setTimeout(processVotes, 5000); // Ù†Ù†ØªØ¸Ø± 5 Ø«ÙˆØ§Ù†ÙŠ Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙˆØ§Øª
                            }
                        });
                    };
                    content.appendChild(b);
                }
            });
            if(!hasTargets) {
                content.innerHTML = "<h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„ØªØµÙˆÙŠØª Ø¶Ø¯Ù‡Ù… Ø­Ø§Ù„ÙŠØ§Ù‹..</h4>";
                setTimeout(() => db.ref(`rooms/${myRoom}/phase`).set('chat'), 3000);
            }
        });
    }

    function processVotes() {
        db.ref(`rooms/${myRoom}/votes`).once('value', snap => {
            let max = 0, target = null, tie = false;
            snap.forEach(v => {
                if(v.val() > max) { max = v.val(); target = v.key; tie = false; }
                else if(v.val() === max) tie = true;
            });

            if(target && !tie) {
                db.ref(`rooms/${myRoom}/players/${target}`).once('value', pSnap => {
                    const realIdentity = pSnap.val().real;
                    db.ref(`rooms/${myRoom}/players/${target}/status`).set('observer');
                    db.ref(`rooms/${myRoom}/msgs`).push({ 
                        user: "Ø§Ù„Ù†Ø¸Ø§Ù…", 
                        text: `ğŸš« ØªÙ… Ø·Ø±Ø¯ [${target}]! Ù‡ÙˆÙŠØªÙ‡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡ÙŠ: [${realIdentity}]` 
                    });
                });
            } else {
                db.ref(`rooms/${myRoom}/msgs`).push({ user: "Ø§Ù„Ù†Ø¸Ø§Ù…", text: `âš–ï¸ Ù„Ù… ÙŠØªÙ… Ø·Ø±Ø¯ Ø£Ø­Ø¯ (ØªØ¹Ø§Ø¯Ù„ Ø£Ùˆ Ù„Ø§ Ø£ØµÙˆØ§Øª).` });
            }

            // ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø¨
            db.ref(`rooms/${myRoom}/votes`).remove();
            db.ref(`rooms/${myRoom}/timer`).set(300);
            db.ref(`rooms/${myRoom}/phase`).set('chat');
        });
    }
    
    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (sendMsg, listenMessages, exitGame) ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ...
</script>

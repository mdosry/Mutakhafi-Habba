<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ®ÙÙŠ Ù‡Ø¨Ù‘Ø© ğŸ­</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --neon-blue: #00d2ff; --bg-dark: #0a0c10; --card-bg: #1c1f26; --accent: #3a86ff; --red: #ff006e; }
        body { background-color: var(--bg-dark); color: white; font-family: 'Tajawal', sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        .btn { background: var(--accent); border: none; color: white; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; width: 100%; }
        .btn-red { background: var(--red) !important; }
        .screen { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; overflow-y: auto; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 25px; width: 100%; max-width: 400px; text-align: center; border: 1px solid #30363d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #30363d; background: #0d1117; color: white; margin-bottom: 12px; text-align: center; font-family: 'Tajawal'; }
        .hint { font-size: 11px; color: #8b949e; margin-top: -8px; margin-bottom: 15px; line-height: 1.4; }
        .hint b { color: var(--neon-blue); }
        #chat-container { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; background: #0d1117; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { background: #21262d; padding: 12px; border-radius: 18px; max-width: 85%; align-self: flex-start; display: flex; gap: 12px; }
        .msg.me { align-self: flex-end; background: var(--accent); flex-direction: row-reverse; }
        .msg-avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--neon-blue); background: #eee; flex-shrink: 0; }
        .job-tag { background: rgba(255,255,255,0.15); padding: 1px 6px; border-radius: 4px; font-size: 9px; margin-right: 5px; }
        .timer-bar { background: var(--red); height: 5px; width: 100%; transition: width 1s linear; }
        .top-bar { padding: 10px 15px; background: #1c1f26; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="setup-screen" class="screen">
        <div class="card">
            <h2 style="color: var(--neon-blue); margin-top:0;">Ù…ØªØ®ÙÙŠ Ù‡Ø¨Ù‘Ø© ğŸ­</h2>
            <input type="number" id="roomNum" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©">
            <input type="text" id="realName" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ">
            <input type="text" id="fakeName" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©">
            <input type="text" id="userJob" placeholder="Ù…Ù‡Ù…ØªÙƒ (Ù…Ø«Ù„: Ø¬Ù†Ø¯ÙŠØŒ Ù‚Ø§Ø¶ÙŠ..)">
            
            <input type="text" id="avatarStyle" placeholder="ÙˆØµÙ Ø´ÙƒÙ„Ùƒ (Ù…Ø«Ù„: old man, glasses)">
            <p class="hint">ğŸ’¡ <b>Ù†ØµÙŠØ­Ø©:</b> Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ§ØªØ§Ø± Ø¯Ù‚ÙŠÙ‚ Ø¬Ø¯Ø§Ù‹ØŒ Ø§ÙƒØªØ¨ Ø§Ù„ÙˆØµÙ Ø¨Ù€ <b>Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</b> (Ù…Ø«Ø§Ù„: <code style="color:white">curly hair, beard</code>)</p>
            
            <button class="btn" onclick="joinGame()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>
    </div>

    <div id="chat-screen" class="screen hidden" style="padding: 0;">
        <div id="chat-container">
            <div id="timer-display" class="timer-bar"></div>
            <div class="top-bar">
                <button class="btn btn-red" style="width: auto; padding: 5px 12px; font-size: 11px;" onclick="exitGame()">Ø®Ø±ÙˆØ¬ ğŸšª</button>
                <span id="time-text" style="color: var(--red); font-weight: bold;">05:00</span>
                <span id="player-display" style="font-size: 13px; font-weight:bold;"></span>
            </div>
            <div id="messages"></div>
            <div style="padding: 15px; background: #161b22; display: flex; gap: 10px;">
                <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹..." style="margin-bottom: 0; flex: 1;">
                <button class="btn" style="width: auto;" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù†ÙØ³ Ø§Ù„ØªÙŠ Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
        const firebaseConfig = {
          apiKey: "AIzaSyBZfqpgix19pOGd_6xFMTV-p2YbrJmLwGo",
          authDomain: "mutakhafi-habba.firebaseapp.com",
          projectId: "mutakhafi-habba",
          storageBucket: "mutakhafi-habba.firebasestorage.app",
          messagingSenderId: "556976912934",
          appId: "1:556976912934:web:aa52c43ae4b0fd8f5344e7",
          databaseURL: "https://mutakhafi-habba-default-rtdb.europe-west1.firebasedatabase.app"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let myNick, myReal, myRoom, myAvatar, myJob;

        function joinGame() {
            myRoom = document.getElementById('roomNum').value;
            myReal = document.getElementById('realName').value;
            myNick = document.getElementById('fakeName').value;
            myJob = document.getElementById('userJob').value || "Ù…ÙˆØ§Ø·Ù†";
            let style = document.getElementById('avatarStyle').value || "person";

            if(!myRoom || !myReal || !myNick) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©!");

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Lorelei Ù„Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©
            myAvatar = `https://api.dicebear.com/7.x/lorelei/svg?seed=${encodeURIComponent(style)}&backgroundColor=b6e3f4`;

            const pRef = db.ref(`rooms/${myRoom}/players/${myNick}`);
            pRef.set({ real: myReal, avatar: myAvatar, job: myJob });
            pRef.onDisconnect().remove();

            document.getElementById('player-display').innerText = myNick;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');

            listenMessages();
            startCounter();
            listenTimer();
        }

        function sendMsg() {
            const val = document.getElementById('msgInput').value;
            if(!val) return;
            db.ref(`rooms/${myRoom}/msgs`).push({ user: myNick, text: val, avatar: myAvatar, job: myJob });
            document.getElementById('msgInput').value = "";
        }

        function listenMessages() {
            db.ref(`rooms/${myRoom}/msgs`).on('child_added', snap => {
                const data = snap.val();
                const div = document.createElement('div');
                div.className = `msg ${data.user === myNick ? 'me' : ''}`;
                div.innerHTML = `<img src="${data.avatar}" class="msg-avatar">
                    <div style="display:flex; flex-direction:column;">
                        <div style="font-size:11px; margin-bottom:4px; opacity:0.8;">
                            <b>${data.user}</b> <span class="job-tag">${data.job}</span>
                        </div>
                        <div style="font-size:14px;">${data.text}</div>
                    </div>`;
                document.getElementById('messages').appendChild(div);
                document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
            });
        }

        function exitGame() {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ÙŠØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Øª Ø¥Ø°Ø§ ÙƒÙ†Øª Ø§Ù„Ø£Ø®ÙŠØ±.")) {
                db.ref(`rooms/${myRoom}/players/${myNick}`).remove().then(() => {
                    db.ref(`rooms/${myRoom}/players`).once('value', snap => {
                        if(!snap.exists()) db.ref(`rooms/${myRoom}`).remove();
                        location.reload();
                    });
                });
            }
        }

        function startCounter() {
            db.ref(`rooms/${myRoom}/players`).limitToFirst(1).on('value', snap => {
                if(snap.exists() && Object.keys(snap.val())[0] === myNick) {
                    if(!window.timerInterval) {
                        window.timerInterval = setInterval(() => {
                            db.ref(`rooms/${myRoom}/timer`).transaction(t => (t > 0 ? t - 1 : 0));
                        }, 1000);
                    }
                }
            });
        }

        function listenTimer() {
            db.ref(`rooms/${myRoom}/timer`).on('value', snap => {
                const timeLeft = snap.val() !== null ? snap.val() : 300;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('time-text').innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
                document.getElementById('timer-display').style.width = (timeLeft / 300 * 100) + "%";
            });
        }
    </script>
</body>
</html>

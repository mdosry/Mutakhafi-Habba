<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ®ÙÙŠ Ù‡Ø¨Ù‘Ø© ğŸ­ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root { --neon: #00d2ff; --bg: #0a0c10; --card: #1c1f26; --accent: #3a86ff; --red: #ff006e; --green: #00c853; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: white; font-family: 'Tajawal', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .hidden { display: none !important; }
        .btn { background: var(--accent); border: none; color: white; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; width: 100%; }
        .btn:active { transform: scale(0.95); }
        .btn-red { background: var(--red) !important; }
        .btn-green { background: var(--green) !important; }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .screen { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .card { background: var(--card); border-radius: 25px; padding: 30px; width: 100%; max-width: 400px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #333; background: #0d1117; color: white; margin-bottom: 12px; text-align: center; font-family: 'Tajawal'; outline: none; }
        input:focus { border-color: var(--neon); }

        /* Ø§Ù„Ø´Ø§Øª */
        #chat-container { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 600px; margin: 0 auto; background: #0d1117; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { background: #21262d; padding: 12px; border-radius: 18px; max-width: 85%; align-self: flex-start; display: flex; gap: 10px; border: 1px solid #30363d; animation: fadeIn 0.3s; }
        .msg.me { align-self: flex-end; background: var(--accent); flex-direction: row-reverse; border: none; }
        .msg-avatar { width: 42px; height: 42px; border-radius: 50%; border: 2px solid var(--neon); background: #eee; flex-shrink: 0; }
        
        .top-bar { padding: 15px; background: var(--card); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .sys-msg { background: rgba(255, 0, 110, 0.1); color: var(--red); border: 1px dashed var(--red); padding: 10px; border-radius: 15px; text-align: center; font-size: 14px; align-self: center; width: 90%; margin: 10px 0; }

        /* Ø§Ù„Ø£ÙˆÙØ±Ù„Ø§ÙŠ (Ø§Ù„ØªØµÙˆÙŠØª) */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="setup-screen" class="screen">
        <div class="card">
            <h1 style="color: var(--neon); margin-top:0;">Ù…ØªØ®ÙÙŠ Ù‡Ø¨Ù‘Ø© ğŸ­</h1>
            <input type="number" id="roomNum" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©">
            <input type="text" id="realName" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ">
            <input type="text" id="fakeName" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±">
            <input type="text" id="userJob" placeholder="Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø³Ø±ÙŠØ©">
            <input type="text" id="avatarStyle" placeholder="ÙˆØµÙ Ø´ÙƒÙ„Ùƒ (English)">
            <button class="btn" onclick="joinGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
        </div>
    </div>

    <div id="chat-screen" class="screen hidden" style="padding: 0;">
        <div id="chat-container">
            <div class="top-bar">
                <button class="btn btn-red" style="width: auto; padding: 8px 15px;" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
                <div id="player-info" style="font-weight: bold; color: var(--neon);"></div>
                <button id="call-vote-btn" class="btn btn-green" style="width: auto; padding: 8px 15px;" onclick="requestVote()">ØªØµÙˆÙŠØª ğŸ—³ï¸</button>
            </div>
            
            <div id="messages"></div>

            <div id="input-area" style="padding: 15px; background: #161b22; display: flex; gap: 10px; border-top: 1px solid #333;">
                <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." style="margin:0; flex:1;">
                <button class="btn" style="width: auto;" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <div id="overlay" class="hidden">
        <div class="card" id="overlay-content"></div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyBZfqpgix19pOGd_6xFMTV-p2YbrJmLwGo",
          authDomain: "mutakhafi-habba.firebaseapp.com",
          projectId: "mutakhafi-habba",
          databaseURL: "https://mutakhafi-habba-default-rtdb.europe-west1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myNick, myReal, myRoom, myAvatar, myJob, isObserver = false, currentPhase = 'chat';

        function joinGame() {
            myRoom = document.getElementById('roomNum').value;
            myReal = document.getElementById('realName').value;
            myNick = document.getElementById('fakeName').value;
            myJob = document.getElementById('userJob').value || "Ù…ÙˆØ§Ø·Ù†";
            let style = document.getElementById('avatarStyle').value || "adventurer";

            if(!myRoom || !myReal || !myNick) return alert("ÙŠØ§ Ù…Ù‡Ù†Ø¯ØŒ Ø¹Ø¨ÙŠ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„!");

            myAvatar = `https://api.dicebear.com/7.x/lorelei/svg?seed=${encodeURIComponent(style)}`;
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨
            const playerRef = db.ref(`rooms/${myRoom}/players/${myNick}`);
            playerRef.set({ real: myReal, avatar: myAvatar, job: myJob, status: 'playing' });
            playerRef.onDisconnect().remove();

            document.getElementById('player-info').innerText = myNick;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');

            initGameListeners();
        }

        function initGameListeners() {
            listenMessages();
            listenPhase();
            listenStatus();
            listenVoteLogic();
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ---
        function sendMsg() {
            if(isObserver) return;
            const val = document.getElementById('msgInput').value;
            if(!val) return;
            db.ref(`rooms/${myRoom}/msgs`).push({ user: myNick, text: val, avatar: myAvatar, job: myJob });
            document.getElementById('msgInput').value = "";
        }

        function listenMessages() {
            db.ref(`rooms/${myRoom}/msgs`).on('child_added', snap => {
                const data = snap.val();
                const div = document.createElement('div');
                if(data.user === "Ø§Ù„Ù†Ø¸Ø§Ù…") {
                    div.className = "sys-msg";
                    div.innerText = data.text;
                } else {
                    div.className = `msg ${data.user === myNick ? 'me' : ''}`;
                    div.innerHTML = `<img src="${data.avatar}" class="msg-avatar">
                                    <div><div style="font-size:10px; opacity:0.7;"><b>${data.user}</b> â€¢ ${data.job}</div>
                                    <div>${data.text}</div></div>`;
                }
                const msgBox = document.getElementById('messages');
                msgBox.appendChild(div);
                msgBox.scrollTop = msgBox.scrollHeight;
            });
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙˆÙŠØª ---
        function requestVote() {
            if(isObserver) return;
            db.ref(`rooms/${myRoom}/voteRequest`).set({ requester: myNick, status: 'pending' });
            db.ref(`rooms/${myRoom}/requestAnswers/${myNick}`).set(true);
        }

        function listenVoteLogic() {
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØµÙˆÙŠØª
            db.ref(`rooms/${myRoom}/voteRequest`).on('value', snap => {
                const data = snap.val();
                if(data && data.status === 'pending' && data.requester !== myNick && currentPhase === 'chat') {
                    showOverlay(`<h3>ğŸš¨ Ø·Ù„Ø¨ ØªØµÙˆÙŠØª</h3><p><b>${data.requester}</b> ÙŠØ±ÙŠØ¯ ÙØªØ­ Ø§Ù„ØªØµÙˆÙŠØª. Ù‡Ù„ ØªÙˆØ§ÙÙ‚ØŸ</p>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-green" onclick="answerRequest(true)">Ù†Ø¹Ù…</button>
                            <button class="btn btn-red" onclick="answerRequest(false)">Ù„Ø§</button>
                        </div>`);
                }
            });

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ØºÙ„Ø¨ÙŠØ© Ù„ÙØªØ­ Ø§Ù„ØªØµÙˆÙŠØª
            db.ref(`rooms/${myRoom}/requestAnswers`).on('value', snap => {
                const answers = snap.val() || {};
                const yesCount = Object.values(answers).filter(v => v === true).length;
                db.ref(`rooms/${myRoom}/players`).once('value', pSnap => {
                    const total = Object.keys(pSnap.val() || {}).length;
                    if(total > 0 && yesCount >= Math.ceil(total / 2)) {
                        db.ref(`rooms/${myRoom}/phase`).set('voting');
                    }
                });
            });
        }

        function answerRequest(ans) {
            db.ref(`rooms/${myRoom}/requestAnswers/${myNick}`).set(ans);
            showOverlay("<h3>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø£ØºÙ„Ø¨ÙŠØ©...â³</h3>");
        }

        function listenPhase() {
            db.ref(`rooms/${myRoom}/phase`).on('value', snap => {
                currentPhase = snap.val() || 'chat';
                if(currentPhase === 'voting') {
                    showVoteScreen();
                } else {
                    hideOverlay();
                    db.ref(`rooms/${myRoom}/voteRequest`).remove();
                    db.ref(`rooms/${myRoom}/requestAnswers`).remove();
                    db.ref(`rooms/${myRoom}/votes`).remove();
                }
            });
        }

        function showVoteScreen() {
            let html = `<h3>ØµÙˆÙ‘Øª Ù„Ù„Ø·Ø±Ø¯ ğŸ—³ï¸</h3><p style="font-size:12px; color:#aaa;">Ø§Ø®ØªØ± Ù…Ù† ØªØ´Ùƒ ÙÙŠÙ‡ (Ø§Ù„Ù‡ÙˆÙŠØ© Ù…Ø®ÙÙŠØ©)</p>`;
            db.ref(`rooms/${myRoom}/players`).once('value', snap => {
                snap.forEach(p => {
                    if(p.val().status === 'playing' && p.key !== myNick) {
                        html += `<button class="btn" style="margin-bottom:8px;" onclick="castVote('${p.key}')">Ø·Ø±Ø¯ ${p.key}</button>`;
                    }
                });
                showOverlay(html);
            });
        }

        function castVote(target) {
            db.ref(`rooms/${myRoom}/votes/${target}`).transaction(v => (v || 0) + 1);
            showOverlay("<h4>ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙƒ! Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬.. ğŸ”’</h4>");
            
            // Ø£ÙˆÙ„ Ù„Ø§Ø¹Ø¨ Ù†Ø´Ø· ÙŠØ­Ø³Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ 6 Ø«ÙˆØ§Ù†ÙŠ
            db.ref(`rooms/${myRoom}/players`).limitToFirst(5).once('value', s => {
                const activeOnes = Object.keys(s.val() || {}).filter(k => s.val()[k].status === 'playing');
                if(activeOnes[0] === myNick) setTimeout(calculateResults, 6000);
            });
        }

        function calculateResults() {
            db.ref(`rooms/${myRoom}/votes`).once('value', snap => {
                let max = 0, target = null, tie = false;
                snap.forEach(v => {
                    if(v.val() > max) { max = v.val(); target = v.key; tie = false; }
                    else if(v.val() === max) tie = true;
                });

                if(target && !tie) {
                    db.ref(`rooms/${myRoom}/players/${target}`).once('value', pSnap => {
                        const real = pSnap.val().real;
                        db.ref(`rooms/${myRoom}/players/${target}/status`).set('observer');
                        db.ref(`rooms/${myRoom}/msgs`).push({ user: "Ø§Ù„Ù†Ø¸Ø§Ù…", text: `ğŸš« ØªÙ… Ø·Ø±Ø¯ [${target}]! ÙˆÙ‡ÙˆÙŠØªÙ‡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡ÙŠ: [${real}]` });
                        db.ref(`rooms/${myRoom}/phase`).set('chat');
                    });
                } else {
                    db.ref(`rooms/${myRoom}/msgs`).push({ user: "Ø§Ù„Ù†Ø¸Ø§Ù…", text: `âš–ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØµÙˆÙŠØª Ø¨Ø§Ù„ØªØ¹Ø§Ø¯Ù„. Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø±Ø¯!` });
                    db.ref(`rooms/${myRoom}/phase`).set('chat');
                }
            });
        }

        // --- Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª (Utilities) ---
        function showOverlay(content) {
            document.getElementById('overlay-content').innerHTML = content;
            document.getElementById('overlay').classList.remove('hidden');
        }

        function hideOverlay() {
            document.getElementById('overlay').classList.add('hidden');
        }

        function listenStatus() {
            db.ref(`rooms/${myRoom}/players/${myNick}/status`).on('value', snap => {
                if(snap.val() === 'observer') {
                    isObserver = true;
                    document.getElementById('input-area').innerHTML = "<p style='color:var(--red); text-align:center; width:100%'>Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…Ø´Ø§Ù‡Ø¯ ğŸ‘ï¸</p>";
                    document.getElementById('call-vote-btn').classList.add('hidden');
                }
            });
        }
    </script>
</body>
</html>
